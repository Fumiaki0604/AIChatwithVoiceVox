<body>
  <script>
    //起動時実行
    window.onload = async function (){
      var select = document.getElementById("speaker_selectbox");
      console.log("起動成功");
      //preloadが終わるまで待つ
      //await preloadImages();

      var data = await new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(function(reply) {
          resolve(reply);
        }).withFailureHandler(function(err) {
          reject(err);
        }).startup();
      });

      var selectBoxIndex = parseInt(data.index);
      var previousSpeakerId = parseInt(data.id);
      select.options[selectBoxIndex].selected = true ;
      changeBackgroundImageBasedOnSelectAssistant(previousSpeakerId);
   
    };

  </script>
(中略)


let eyeUrls = [];
  var blinkIntervalId;
  
  function changeBackgroundImageBasedOnSelectAssistant(speakerId) {
    clearTimeout(blinkIntervalId);  // 追加

    if (speakerId == 7) {        //ずんだもん 
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1bA2hz8_DTs6AgL5lrcMT6l1m2crBWxI7",
        "https://lh3.googleusercontent.com/d/1s68PCO2PVi388zLLaf-ZDF0FCnmRrSTt",
        "https://lh3.googleusercontent.com/d/1OPb917qsKv1Ut2GqJNTfUVw_OMCdOZpe"
      );
    }else if (speakerId == 6) {//四国めたん 
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1LkATbwu2Hd26HM40kjdBFAQ7HgZY0dGm",
        "https://lh3.googleusercontent.com/d/1BkhF9x8v8-vzEgCCg6yW__nUesxyO0M2",
        "https://lh3.googleusercontent.com/d/1-ZYh3wlFSwQrxXmu3q_Bt3FckRbw3I_c"
      );
    
    eyeUrls = blinkImages(speakerId);
    
    // blinkAtRandomIntervals を呼び出します。
    let interval = 3500 ;
      setTimeout(function(){
        toggleEyes(eyeUrls);
        blinkIntervalId = blinkAtRandomIntervalsWithDelay(eyeUrls, 5000);  // 変更
        //blinkAtRandomIntervals(eyeUrls)
      }, interval);
    }

  // 新しい関数：指定時間後にまばたきを開始します
  function blinkAtRandomIntervalsWithDelay(eyeUrls, delay) {
    return setTimeout(function (){  // 変更: setTimeout の id を返す
      blinkAtRandomIntervals(eyeUrls)
    }, delay);
  }

  function changeBackgroundImage(bodyUrl, faceURL, mouseURL) {
    const ids = ['characterbody', 'face', 'mouse'];
    const urls = [bodyUrl, faceURL, mouseURL];

    // Fade out current images
    ids.forEach((id, index) => {
        let element = document.getElementById(id);
        element.classList.add('fadeout');

        // After transition duration, change background image and fade in
        setTimeout(() => {
            element.style.backgroundImage = `url(${urls[index]})`;
            element.classList.remove('fadeout');
        }, 2000); // This should match the duration of your opacity transition
    });
  }

  let faceContainer = document.getElementById('face');

  function openEyes() {
    console.log("open");
   
    faceContainer.style.backgroundImage = `url('${eyeUrls[0]}')`;
    faceContainer.classList.remove('closedEyes');
    faceContainer.classList.add('openEyes');
  }

  function closeEyes() {
    console.log("close");
    
    faceContainer.style.backgroundImage = `url('${eyeUrls[1]}')`;
    faceContainer.classList.remove('openEyes');
    faceContainer.classList.add('closedEyes');
  }

  function toggleEyes() {
    if (faceContainer.classList.contains('openEyes')) {
      closeEyes();
      let interval = Math.random() * (100) + 150;
      setTimeout(() => openEyes(), interval);
    } else {
      openEyes();
    }
  }

  function blinkAtRandomIntervals(eyeUrls){
    let interval = Math.random() * (1000) + 2500;
    blinkIntervalId = setTimeout(function(){  // 変更: setTimeout の id を保存
      toggleEyes(eyeUrls);
      blinkAtRandomIntervals(eyeUrls)
    }, interval);
  }

  blinkAtRandomIntervals(eyeUrls);

  function blinkImages(speakerId){
    let eyeUrls = [];
    if  (speakerId == 7){     //ずんだもん
      eyeUrls = ["https://lh3.googleusercontent.com/d/1s68PCO2PVi388zLLaf-ZDF0FCnmRrSTt", "https://lh3.googleusercontent.com/d/10OSTnhq7kIK_aZXokENbKxbhc9GRaPwd"];
    }
    else if (speakerId == 6) {//四国めたん
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1BkhF9x8v8-vzEgCCg6yW__nUesxyO0M2", "https://lh3.googleusercontent.com/d/1Axc2mjDyJkiO39U4lSyhistF0tdkodLF"];
    }
    return eyeUrls ;
  }
</script>