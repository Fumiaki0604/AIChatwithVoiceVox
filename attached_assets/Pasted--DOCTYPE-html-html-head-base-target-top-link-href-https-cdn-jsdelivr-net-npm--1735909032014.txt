<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <!-- <meta charset="UTF-8">-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>リップシンク</title>
  <style>
  body {
    max-width: 90%;
    width: 100%;
    margin: 0 auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    height: 100vh;
  }
 
  .control-panel {
    position: relative;
    z-index: 2;
  }

  #parentContainer {
    position: fixed;
    right: 0;
    width: 32%; /* adjust as needed */
    height: 100%;
    transition: opacity 2.0s ease-in-out; 
    opacity: 1;
  }
  .image-container {
    position: absolute;
    background-position: right 100% bottom 5% ;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    /* width: 360px;
    height: auto; */
    background-size: cover;
    transition: opacity 2.0s ease-in-out; /* Adjust as needed */
  }

  .fadeout {
    opacity: 0 !important;
  }

  #characterbody, #mouse, #face {
    background-size: 360px auto;
    background-repeat: no-repeat;
  }

  #characterbody {
    background-image: url('https://lh3.googleusercontent.com/d/1i4tjvBkv6VkL4gj9t_kSCxDEjHppTSxn');
    z-index: 1;
  }

  #mouse {
    background-image: url('https://lh3.googleusercontent.com/d/1i4tjvBkv6VkL4gj9t_kSCxDEjHppTSxn');
    z-index: 2;
  }

  #face {
    background-image: url('https://lh3.googleusercontent.com/d/1i4tjvBkv6VkL4gj9t_kSCxDEjHppTSxn');
    z-index: 3;
  }

  #responseContainer {
    position: fixed;
    right: 35%; /* set this to the same percentage as the width of #parentContainer */
   
    min-height: calc(6 * 1.2em * 2.5);
    max-height: calc(6 * 1.2em * 2.5);
    width: 65%; /* adjust as needed */
    overflow-y: scroll;
    border: 1px solid #ccc;
    padding: 5px;
    margin-bottom: 0.5em;
    box-sizing: border-box;
    background-color: rgba(255, 255, 255, 0.7);
    bottom: 30px;
    left: 30px;
    z-index: 1;
  }


  #feedContainer {
    min-height: calc(6 * 1.2em * 4.0);
    max-height: calc(6 * 1.2em * 4.0);
    width: 65%;
    overflow-y: scroll;
    padding: 5px;
    /* Add these lines */
    position: absolute;
    top: 30px; /*追記*/
    left: 30px; /*追記*/
    z-index: 1;
  }
  
  .selectbox-005 {  
    display: inline-flex;
    align-items: center;
    /* Add these lines */
    position: absolute;
    bottom: calc(6 * 1.2em * 2.5 + 40px);
    left: 30px;
    z-index: 2;
  }

  .selectbox-005::after {
    position: absolute;
    right: 15px;
    width: 10px;
    height: 7px;
    background-color: rgba(255, 255, 255, 0.7);
    clip-path: polygon(0 0, 100% 0, 50% 100%);
    content: '';
    pointer-events: none;
  }

  .selectbox-005 select {
    appearance: none;
    min-width: 230px;
    height: 2.8em;
    padding: .4em calc(.8em + 30px) .4em .8em;
    border: none;
    border-bottom: 2px solid #cccccc;
    background-color: rgba(255, 255, 255, 0.7);
    color: #5f5858;
    font-size: 1em;
    cursor: pointer;
  }

  .selectbox-005 select:focus {
    outline: none;
  }
</style>

<script>

    const imagesToPreload = [
      //ずんだもん 
      "https://lh3.googleusercontent.com/d/1bA2hz8_DTs6AgL5lrcMT6l1m2crBWxI7",
      "https://lh3.googleusercontent.com/d/1s68PCO2PVi388zLLaf-ZDF0FCnmRrSTt",
      "https://lh3.googleusercontent.com/d/1OPb917qsKv1Ut2GqJNTfUVw_OMCdOZpe",
      "https://lh3.googleusercontent.com/d/10OSTnhq7kIK_aZXokENbKxbhc9GRaPwd", 
      "https://lh3.googleusercontent.com/d/1Ri5j3esyS13MhzUuRBhXiGt5HtMblmL2",
      "https://lh3.googleusercontent.com/d/1DkEcHTfiLSg4NocQQ8zbaByXbMPnPQaw",
      "https://lh3.googleusercontent.com/d/1Zu6ZJlEwfc_qrbzfxqC-EdxA3p9eRYdP",
       //四国めたん 
      "https://lh3.googleusercontent.com/d/1LkATbwu2Hd26HM40kjdBFAQ7HgZY0dGm",
      "https://lh3.googleusercontent.com/d/1-ZYh3wlFSwQrxXmu3q_Bt3FckRbw3I_c",
      "https://lh3.googleusercontent.com/d/1BkhF9x8v8-vzEgCCg6yW__nUesxyO0M2",
      "https://lh3.googleusercontent.com/d/1Axc2mjDyJkiO39U4lSyhistF0tdkodLF",
      "https://lh3.googleusercontent.com/d/1RyaRYCEgm9pq5nlf_uKqfuTqY_L9N-iZ",
      "https://lh3.googleusercontent.com/d/1Nd9TLTOT02Gx0MR6Yk0c9HsJAhNRTLMT",
      "https://lh3.googleusercontent.com/d/1s-mRiQ_G48bpIKmK5l46n8mEbI48t8OV",
      //春日部つむぎ
      "https://lh3.googleusercontent.com/d/1daZPJgFB6UrL59LhtESwvbzgfKulR6WJ",
      "https://lh3.googleusercontent.com/d/1xe8ODHTE7gG7f_rp1JfM8hPikUttJRw9",
      "https://lh3.googleusercontent.com/d/1zYzQER8V-DDteVBHIWwfQo4jEbPlHsNH",
      "https://lh3.googleusercontent.com/d/14p_61U-Pk2EY2D0S4bXfU9j3wz4s_BRo",
      "https://lh3.googleusercontent.com/d/1aZckv1zz5BN_eLZsokNtgm2jibJ8SjNt",
      "https://lh3.googleusercontent.com/d/1noH7lIW5HT1nG2xQJpjIr2EXTlahaWXF",
      //中国うさぎ
      "https://lh3.googleusercontent.com/d/1t2qWPGpjJ4wFarK__sUZ9YPvUvTvZXYj",
      "https://lh3.googleusercontent.com/d/1vl_FPWazcyVhcX6fdfpQrCaY9XGzFYFW",
      "https://lh3.googleusercontent.com/d/1yEK-5gKUt8LwttYBRll2TOb4FeMAhU7z",
      "https://lh3.googleusercontent.com/d/1EUEPEcZTc4GxWXEYJGG8K-_vGf46gDda",
      "https://lh3.googleusercontent.com/d/16vnkj-iIsWUljGF6qw-CA6vloG406x1y",
      "https://lh3.googleusercontent.com/d/14I7sfJAJWvo8xzwYxCJTTGzlU1Iry2um",
      "https://lh3.googleusercontent.com/d/1y6VMAyr-FmfPEtLDBtGy8_WdQwsI_Vuu",
      //九州そら
      "https://lh3.googleusercontent.com/d/1U_VNHFngT88Bc_4XIpun7kyXi2Ujf4IQ",
      "https://lh3.googleusercontent.com/d/1HAOuIiyVaqH-SmhVSBX0XpyjZr71r38B",
      "https://lh3.googleusercontent.com/d/19TOru9JL8LWaEJ9e6XrEUcWQp749NTof",
      "https://lh3.googleusercontent.com/d/11LzrvEV5c_RP889QJe7MUMYh2QMuqyp1",
      "https://lh3.googleusercontent.com/d/1wSWTN3BHSu_g5cBy4R_ueSLzAM5tg6yi",
      "https://lh3.googleusercontent.com/d/1HhHfq-NRjlFNejnMwHywX89QmfHPqb8H",
      "https://lh3.googleusercontent.com/d/1prlZOo8-riTF4rLToCSfhTskrInqzCnv",
      //後鬼
      "https://lh3.googleusercontent.com/d/1ra5nD2HlZZ6X85FlPI2lznWewCMwwtM6",
      "https://lh3.googleusercontent.com/d/1D0SrixrMmkqmfxCZjLIlla8gFR4EjuzO",
      "https://lh3.googleusercontent.com/d/1wpiHmeB4oN1e7XsbUYAJZf3Ji7k-2irc",
      "https://lh3.googleusercontent.com/d/1B9Ize68pUaUBzf1NAS4QkxyY9npb0WE7",
      "https://lh3.googleusercontent.com/d/1KVNU7lcB9nRP_RwSdKOX3PwckUaGP_T_",
      "https://lh3.googleusercontent.com/d/1UlPdtJOvRMwun65zwidzYw3WvCdc_IaB",
      "https://lh3.googleusercontent.com/d/1gK8HxZ1b4kRgOpoodilXe17pVysc3z2_",
      //WhiteCul
      "https://lh3.googleusercontent.com/d/1YWJYd9mwjCNcFUCEs_u7MDewCRaa5NiJ",
      "https://lh3.googleusercontent.com/d/16ID3H5NhfhV4Yo_9LRaf2aQV7dr8DS68",
      "https://lh3.googleusercontent.com/d/183q3VSArPBL4REjjyZtagSTltByu6TD0",
      "https://lh3.googleusercontent.com/d/1zL34c6j9l3zoLi-cjrq2nImv_-gPrl1T",
      "https://lh3.googleusercontent.com/d/1-d3stj0j3HpgCZDoTpl0EQeJraoaplOQ",
      "https://lh3.googleusercontent.com/d/1rZWC0QhJM6adaebacg6rpDn0gdRDKta8",
      "https://lh3.googleusercontent.com/d/1_9WhQ9wsy5uuLV8y_kcqJ0IgZqlWv7cR",
      //雨晴はう
      "https://lh3.googleusercontent.com/d/1BHU9kEKgyODkfdaTPphDo9-usvHh0vBP",
      "https://lh3.googleusercontent.com/d/1AfQNuQHLU9qF4UjSYBCGL2v1aMN6nYbY",
      "https://lh3.googleusercontent.com/d/1bn9LvyVpMs51gusF7Fs0RUE0jvu6w7Rs",
      "https://lh3.googleusercontent.com/d/15LXPJr8G6y0yaAJrDehj7Nc3Usl8qARB",
      "https://lh3.googleusercontent.com/d/1bV2A2sa-xWZw2BV9elqQF8jPxDVdmAAt",
      "https://lh3.googleusercontent.com/d/1yog_o50i28O8oBBQm6nz8IyeHW_lQokT",
      "https://lh3.googleusercontent.com/d/1YRecv1c7VgfaMt-wlNvHNh_Hm3YZ1AWR"
    ];

    // function preloadImages() {
    //     for (const imageUrl of imagesToPreload) {
    //       const img = new Image();
    //       img.src = imageUrl;
    //     }
    //   }

    function preloadImages() {
      let loadedImageCount = 0;
    
      for (const imageUrl of imagesToPreload) {
        const img = new Image();
        img.src = imageUrl;
        img.onload = () => {
            loadedImageCount++;
            if (loadedImageCount === imagesToPreload.length) {
                // 全ての画像が読み込まれたときの処理をここに記述
                console.log('All images have been loaded.');
            }
        };
      }
    }

window.addEventListener("load", preloadImages);

</script>
</head>
<body>
  <script>
    //起動時実行
    window.onload = async function (){
      var select = document.getElementById("speaker_selectbox");
      console.log("起動成功");
      //preloadが終わるまで待つ
      //await preloadImages();

      var data = await new Promise((resolve, reject) => {
        google.script.run.withSuccessHandler(function(reply) {
          resolve(reply);
        }).withFailureHandler(function(err) {
          reject(err);
        }).startup();
      });

      var selectBoxIndex = parseInt(data.index);
      var previousSpeakerId = parseInt(data.id);
      select.options[selectBoxIndex].selected = true ;
      changeBackgroundImageBasedOnSelectAssistant(previousSpeakerId);
   
    };

  </script>
  <script>

    const scrollAnimationDuration = 2000;
    async function showUserMessage(userMessage) {
        const responseContainer = document.getElementById("responseContainer");
      
        responseContainer.innerHTML = "";
        //メッセージ受信中
        await typeMessage(responseContainer, userMessage + "<br>");
       
        responseContainer.scrollTop = responseContainer.scrollHeight;
       //document.querySelector("button").disabled = true;
        //document.getElementById("speaker_selectbox").disabled = true;
        await new Promise(resolve => setTimeout(resolve, scrollAnimationDuration));
      }
      // メッセージをタイプライティング演出で表示する非同期関数
      // @param {HTMLElement} element - メッセージを表示するHTML要素
      // @param {string} message - 表示するメッセージ
      async function typeMessage(element, message) {
        // メッセージの一時保存用
        let temp = "";
  
        // HTMLタグが現在解析中かどうかを判断するフラグ
        let isTag = false;
  
        // 最初に取得した要素の高さを保持します。
        const initialHeight = element.scrollHeight;
  
        // 元のコンテンツ
        const originalContent = element.innerHTML;
  
        // メッセージの各文字に対して操作を行います。
 
        for (let i = 0; i < message.length; i++) {
          // 現在の文字が"<br>"の開始部分である場合
          // ("<", "b", "r", ">")
          if (message[i] === "<" && message[i + 1] === "b" && message[i + 2] === "r" && message[i + 3] === ">") {
            temp += "<br>";
            i += 3;
            isTag = true;
          } else {
            // 現在の文字をtempに追加します。
            temp += message[i];      
          }
          // HTML要素の内容を現在のtempで更新します。
          element.innerHTML = originalContent + temp;
          // 135ミリ秒待機します
          // (これにより、文字が一つずつ表示されるアニメーション効果が得られます)
          await new Promise(resolve => setTimeout(resolve, 135));
    
          // スクロール領域（scrollHeight）が可視領域（clientHeight）を超えていたらスクロールする
          if (element.scrollHeight > element.clientHeight) {
            const scrollAmount = element.scrollHeight - element.clientHeight;
            smoothScroll(element, element.scrollTop + scrollAmount, scrollAnimationDuration);
          } else {
            // 最下部までスクロールします。
            element.scrollTop = element.scrollHeight;
          }
        }
      }

    function smoothScroll(element, target, duration) {
      const start = element.scrollTop;
      const change = target - start;
      const startTime = performance.now();
      function animateScroll(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        element.scrollTop = start + change * progress;
        if (progress < 1) {
          requestAnimationFrame(animateScroll);
        }
      }
      requestAnimationFrame(animateScroll);
    }

    function submitForm(url) {

      google.script.run.withSuccessHandler(async function (reply) {
        console.log(reply.id);
        console.log(reply.message);

        await play(reply.message, reply.id)
    
      }).sendMessage(url);
    }
  </script>
 
  <div id="feedContainer">
    <!-- <form class="mb-5" method="POST"> -->
      <? output._ = formHTML ?>
    <!-- </form> -->
  </div>
  <div class="control-panel">
  </div>
  <label class="selectbox-005">
    <select name="speaker" id="speaker_selectbox">
      <option>選択してください</option>
      <option value="7" name="ずんだもん">ずんだもん</option>
      <option value="6" name="四国めたん">四国めたん</option>
      <option value="8" name="春日部つむぎ">春日部つむぎ</option>
      <option value="61"name="中国うさぎ">中国うさぎ</option>
      <option value="10"name="雨晴はう">雨晴はう</option>
      <option value="23"name="WhiteCUL">WhiteCUL</option>
      <option value="18"name="九州そら">九州そら</option>
      <option value="28"name="後鬼(非公式擬人化ver.)">後鬼(非公式擬人化ver.)</option>
    </select>
  </label>
  <script>
    var selectBox = document.querySelector('.selectbox-005 select');
        
    selectBox.addEventListener('change', function(event) {
      speakerId = event.target.value;
            //selectBoxOption(false);
      var selectedIndex = event.target.selectedIndex;
            
      // 追加部分 - 選択されたオプションのname属性を取得
      speakerName = event.target.options[event.target.selectedIndex].getAttribute('name');
    
      writeSpeakersammary(speakerId,speakerName,selectedIndex);
      changeBackgroundImageBasedOnSelectAssistant(speakerId);
      //selectBoxOption(true);
    });
        
  </script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', (event) => {
          const buttons = document.querySelectorAll('.btn');
          buttons.forEach(button => {
            button.addEventListener('click', (e) => {
              e.preventDefault();
                  
              var value = e.target.value;
              console.log(value);
              submitForm(value);
            });
          });
    });
  </script>
  <div id="parentContainer">
    <div class="image-container" id="characterbody"></div>
    <div class="image-container" id="mouse"></div>
    <div class="image-container" id="face"></div>
  </div>
  <div id="responseContainer"></div>
</body>
</html>


<script>
  class TtsQuestV3Voicevox extends Audio {
    constructor(speakerId, text, ttsQuestApiKey) {
      super();
      var params = {};
      params['key'] = ttsQuestApiKey;
      params['speaker'] = speakerId;
      params['text'] = text;
      const query = new URLSearchParams(params);
      this.mp3StreamingUrl = '';
      this.loadPromise = this.#main(this, query);
    }

    #main(owner, query) {
      var apiUrl = 'https://api.tts.quest/v3/voicevox/synthesis';

      return fetch(apiUrl + '?' + query.toString())
        .then(response => response.json())
        .then(response => {
        console.log("ステータスコード"+response.success);
        if (typeof response.retryAfter !== 'undefined') {
          return new Promise(resolve => 
            setTimeout(() => resolve(this.#main(owner, query)), 
                   1000*(1+response.retryAfter)));
        }
        else if (typeof response.mp3StreamingUrl !== 'undefined') {
          owner.mp3StreamingUrl = response.mp3StreamingUrl;
        }
        else if (typeof response.errorMessage !== 'undefined') {
          throw new Error(response.errorMessage);
        }
        else {
          throw new Error("Server error");
        }
      });
    }

    play() {
      return this.loadPromise.then(() => this.mp3StreamingUrl);
    }
  }

  let ctx = null // AudioContext: Nodeの作成、音声のデコードの制御などを行う
  let audioSrc = null // AudioBufferSourceNode: 音声入力ノード
  let analyser = null // AnalyserNode: 音声解析ノード
  let sampleInterval = null
  let prevSpec = 0 // 前回のサンプリングで取得したスペクトルの配列
  const mouseElement = document.getElementById('mouse');
  const buttons = document.querySelectorAll('button')

  /* 音声データをAudioBufferに変換 */
  async function preparedBuffer(voice_path) {
    ctx = new AudioContext()
    const res = await fetch(voice_path)
    const arrayBuffer = await res.arrayBuffer()
    const audioBuffer = await ctx.decodeAudioData(arrayBuffer)

    return audioBuffer
  }

  /* 入力ノード、Analyserノードを生成し、出力層に接続 */
  function buildNodes(audioBuffer) {
    audioSrc = new AudioBufferSourceNode(ctx, { buffer: audioBuffer })
    analyser = new AnalyserNode(ctx)
    analyser.fftSize = 512
    audioSrc.connect(analyser).connect(ctx.destination)
  }

  /* スペクトルをもとにリップシンクを行う */
  function syncLip(spectrums,voicevox_id) {
    let totalSpec = 0
    const vocalRangeSpectrums = spectrums.slice(0, spectrums.length / 2) // 音声の主要周波数帯を取得 
    const totalSpectrum = vocalRangeSpectrums.reduce(function(a, x) { return a + x }) // 周波数帯内の全スペクトラムの合計を算出
    var spec = prevSpec - totalSpectrum ;
    console.log("spec"+spec);
    //console.log("ID"+id);

      if(voicevox_id == 6){
         if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1RyaRYCEgm9pq5nlf_uKqfuTqY_L9N-iZ')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1Nd9TLTOT02Gx0MR6Yk0c9HsJAhNRTLMT')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1s-mRiQ_G48bpIKmK5l46n8mEbI48t8OV')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1-ZYh3wlFSwQrxXmu3q_Bt3FckRbw3I_c')";
        }
      }else if(voicevox_id == 7){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1Ri5j3esyS13MhzUuRBhXiGt5HtMblmL2')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1DkEcHTfiLSg4NocQQ8zbaByXbMPnPQaw')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1Zu6ZJlEwfc_qrbzfxqC-EdxA3p9eRYdP')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1OPb917qsKv1Ut2GqJNTfUVw_OMCdOZpe')";
        }
      }
      else if(voicevox_id == 8){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/14p_61U-Pk2EY2D0S4bXfU9j3wz4s_BRo')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1aZckv1zz5BN_eLZsokNtgm2jibJ8SjNt')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1noH7lIW5HT1nG2xQJpjIr2EXTlahaWXF')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1PVsUD6Aogtc7L5NkV8yrCLT6xZFTj7GS')";
        }
      }
      else if(voicevox_id == 61){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1EUEPEcZTc4GxWXEYJGG8K-_vGf46gDda')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/16vnkj-iIsWUljGF6qw-CA6vloG406x1y')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/14I7sfJAJWvo8xzwYxCJTTGzlU1Iry2um')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1y6VMAyr-FmfPEtLDBtGy8_WdQwsI_Vuu')";
        }
      }
      else if(voicevox_id == 23){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1zL34c6j9l3zoLi-cjrq2nImv_-gPrl1T')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1-d3stj0j3HpgCZDoTpl0EQeJraoaplOQ')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1rZWC0QhJM6adaebacg6rpDn0gdRDKta8')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1_9WhQ9wsy5uuLV8y_kcqJ0IgZqlWv7cR')";
        }
      }
      else if(voicevox_id == 10){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/15LXPJr8G6y0yaAJrDehj7Nc3Usl8qARB')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1bV2A2sa-xWZw2BV9elqQF8jPxDVdmAAt')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1yog_o50i28O8oBBQm6nz8IyeHW_lQokT')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1YRecv1c7VgfaMt-wlNvHNh_Hm3YZ1AWR')";
        }
      }
      else if(voicevox_id == 18){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/11LzrvEV5c_RP889QJe7MUMYh2QMuqyp1')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1wSWTN3BHSu_g5cBy4R_ueSLzAM5tg6yi')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1HhHfq-NRjlFNejnMwHywX89QmfHPqb8H')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1prlZOo8-riTF4rLToCSfhTskrInqzCnv')";
        }
      }
      else if(voicevox_id == 28){
        if (totalSpectrum > prevSpec) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1gK8HxZ1b4kRgOpoodilXe17pVysc3z2_')";
        } else if (prevSpec - totalSpectrum < 250) {
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1UlPdtJOvRMwun65zwidzYw3WvCdc_IaB')";
        } else if (prevSpec - totalSpectrum < 500){
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1KVNU7lcB9nRP_RwSdKOX3PwckUaGP_T_')";
        } else{
            mouseElement.style.backgroundImage = "url('https://lh3.googleusercontent.com/d/1B9Ize68pUaUBzf1NAS4QkxyY9npb0WE7')";
        }
      }                  

    prevSpec = totalSpectrum
  }

  /* 音声再生処理 */
  async function playVoice(voice_path,voicevox_id,message) {
    console.log("playvoice呼び出し");
    console.log(voice_path);
    console.log(voicevox_id);
    // 音声再生中はボタンを無効化し、2重で再生できないようにする
    buttons.forEach(button => {
      button.disabled = true
    })

    const audioBuffer = await preparedBuffer(voice_path) // audioBuffer取得
    buildNodes(audioBuffer) // 入力、解析ノード作成
    audioSrc.start() // 音声再生開始
    //メッセージ表示開始
    setTimeout(() => {
      showUserMessage(message);
    }, 1500);
    // 50ms毎に音声のサンプリング→解析→リップシンクを行う
    sampleInterval = setInterval(() => {
      let spectrums = new Uint8Array(analyser.fftSize)
      analyser.getByteFrequencyData(spectrums)
      syncLip(spectrums,voicevox_id)
    }, 50)

    // 音声終了時のコールバック： リソースの開放、無効化していたボタンを有効化する
    audioSrc.onended = () => {
      clearInterval(sampleInterval)
      audioSrc = null
      ctx.close()
      ctx = null
      prevSpec = 0
      buttons.forEach(button => {
        button.disabled = false
      })
    }
  }

  async function play(text,id) {
    var ttsQuestApiKey = 'p-s205e-L706841' // optional
    var audio = new TtsQuestV3Voicevox(id, text, ttsQuestApiKey);

    // mp3 URLを取得します
    var mp3Url = await audio.play();
    console.log(mp3Url); // https://audio2.tts.quest/v1/data/b770663a93a23a38bfe422a48ec341fa45cf0bfb14a597b1a5690bf3b831041e/audio.mp3
    playVoice(mp3Url,id,text);
  }

  //selectBoxが変更されたとき、voicevoxの話し手の情報をpropertyに記録させる
  function writeSpeakersammary(id,name,index) {
    // const sendButton = document.querySelector("button");
    // sendButton.disabled = true;
 
    google.script.run.withSuccessHandler(function(reply) {
        console.log(reply.message);
    }).writeSpeaker(id,name,index);
  }

  let eyeUrls = [];
  var blinkIntervalId;
  
  function changeBackgroundImageBasedOnSelectAssistant(speakerId) {
    clearTimeout(blinkIntervalId);  // 追加

    if (speakerId == 7) {        //ずんだもん 
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1bA2hz8_DTs6AgL5lrcMT6l1m2crBWxI7",
        "https://lh3.googleusercontent.com/d/1s68PCO2PVi388zLLaf-ZDF0FCnmRrSTt",
        "https://lh3.googleusercontent.com/d/1OPb917qsKv1Ut2GqJNTfUVw_OMCdOZpe"
      );
    }else if (speakerId == 6) {//四国めたん 
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1LkATbwu2Hd26HM40kjdBFAQ7HgZY0dGm",
        "https://lh3.googleusercontent.com/d/1BkhF9x8v8-vzEgCCg6yW__nUesxyO0M2",
        "https://lh3.googleusercontent.com/d/1-ZYh3wlFSwQrxXmu3q_Bt3FckRbw3I_c"
      );

    } else if (speakerId == 8) {//春日部つむぎ
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1daZPJgFB6UrL59LhtESwvbzgfKulR6WJ",
        "https://lh3.googleusercontent.com/d/1xe8ODHTE7gG7f_rp1JfM8hPikUttJRw9",
        "https://lh3.googleusercontent.com/d/1aZckv1zz5BN_eLZsokNtgm2jibJ8SjNt"
      );
    } else if (speakerId == 61) {//中国うさぎ
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1t2qWPGpjJ4wFarK__sUZ9YPvUvTvZXYj",
        "https://lh3.googleusercontent.com/d/1vl_FPWazcyVhcX6fdfpQrCaY9XGzFYFW",
        "https://lh3.googleusercontent.com/d/1y6VMAyr-FmfPEtLDBtGy8_WdQwsI_Vuu",
      );
    } else if (speakerId == 10) {//雨晴はう
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1BHU9kEKgyODkfdaTPphDo9-usvHh0vBP",
        "https://lh3.googleusercontent.com/d/1AfQNuQHLU9qF4UjSYBCGL2v1aMN6nYbY",
        "https://lh3.googleusercontent.com/d/1YRecv1c7VgfaMt-wlNvHNh_Hm3YZ1AWR",
      );
    } else if (speakerId == 23) {//WhiteCul
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1YWJYd9mwjCNcFUCEs_u7MDewCRaa5NiJ",
        "https://lh3.googleusercontent.com/d/16ID3H5NhfhV4Yo_9LRaf2aQV7dr8DS68",
        "https://lh3.googleusercontent.com/d/1_9WhQ9wsy5uuLV8y_kcqJ0IgZqlWv7cR",
      );
    } else if (speakerId == 18) {//九州そら
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1U_VNHFngT88Bc_4XIpun7kyXi2Ujf4IQ",
        "https://lh3.googleusercontent.com/d/1HAOuIiyVaqH-SmhVSBX0XpyjZr71r38B",
        "https://lh3.googleusercontent.com/d/1prlZOo8-riTF4rLToCSfhTskrInqzCnv",
      );
    } else if(speakerId == 28) {//後鬼(非公式擬人化ver.)
      changeBackgroundImage(
        "https://lh3.googleusercontent.com/d/1ra5nD2HlZZ6X85FlPI2lznWewCMwwtM6",
        "https://lh3.googleusercontent.com/d/1D0SrixrMmkqmfxCZjLIlla8gFR4EjuzO",
        "https://lh3.googleusercontent.com/d/1B9Ize68pUaUBzf1NAS4QkxyY9npb0WE7",
      );
    } 
    
    eyeUrls = blinkImages(speakerId);
    
    // blinkAtRandomIntervals を呼び出します。
    let interval = 3500 ;
      setTimeout(function(){
        toggleEyes(eyeUrls);
        blinkIntervalId = blinkAtRandomIntervalsWithDelay(eyeUrls, 5000);  // 変更
        //blinkAtRandomIntervals(eyeUrls)
      }, interval);
    }

  // 新しい関数：指定時間後にまばたきを開始します
  function blinkAtRandomIntervalsWithDelay(eyeUrls, delay) {
    return setTimeout(function (){  // 変更: setTimeout の id を返す
      blinkAtRandomIntervals(eyeUrls)
    }, delay);
  }

  function changeBackgroundImage(bodyUrl, faceURL, mouseURL) {
    const ids = ['characterbody', 'face', 'mouse'];
    const urls = [bodyUrl, faceURL, mouseURL];

    // Fade out current images
    ids.forEach((id, index) => {
        let element = document.getElementById(id);
        element.classList.add('fadeout');

        // After transition duration, change background image and fade in
        setTimeout(() => {
            element.style.backgroundImage = `url(${urls[index]})`;
            element.classList.remove('fadeout');
        }, 2000); // This should match the duration of your opacity transition
    });
  }

  let faceContainer = document.getElementById('face');

  function openEyes() {
    console.log("open");
   
    faceContainer.style.backgroundImage = `url('${eyeUrls[0]}')`;
    faceContainer.classList.remove('closedEyes');
    faceContainer.classList.add('openEyes');
  }

  function closeEyes() {
    console.log("close");
    
    faceContainer.style.backgroundImage = `url('${eyeUrls[1]}')`;
    faceContainer.classList.remove('openEyes');
    faceContainer.classList.add('closedEyes');
  }

  function toggleEyes() {
    if (faceContainer.classList.contains('openEyes')) {
      closeEyes();
      let interval = Math.random() * (100) + 150;
      setTimeout(() => openEyes(), interval);
    } else {
      openEyes();
    }
  }

  function blinkAtRandomIntervals(eyeUrls){
    let interval = Math.random() * (1000) + 2500;
    blinkIntervalId = setTimeout(function(){  // 変更: setTimeout の id を保存
      toggleEyes(eyeUrls);
      blinkAtRandomIntervals(eyeUrls)
    }, interval);
  }

  blinkAtRandomIntervals(eyeUrls);

  function blinkImages(speakerId){
    let eyeUrls = [];
    if  (speakerId == 7){     //ずんだもん
      eyeUrls = ["https://lh3.googleusercontent.com/d/1s68PCO2PVi388zLLaf-ZDF0FCnmRrSTt", "https://lh3.googleusercontent.com/d/10OSTnhq7kIK_aZXokENbKxbhc9GRaPwd"];
    }
    else if (speakerId == 6) {//四国めたん
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1BkhF9x8v8-vzEgCCg6yW__nUesxyO0M2", "https://lh3.googleusercontent.com/d/1Axc2mjDyJkiO39U4lSyhistF0tdkodLF"];
    }
    else if (speakerId == 8) {//春日部つむぎ
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1xe8ODHTE7gG7f_rp1JfM8hPikUttJRw9", "https://lh3.googleusercontent.com/d/1zYzQER8V-DDteVBHIWwfQo4jEbPlHsNH"];
    }
    else if (speakerId == 61) {//中国うさぎ
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1vl_FPWazcyVhcX6fdfpQrCaY9XGzFYFW", "https://lh3.googleusercontent.com/d/1yEK-5gKUt8LwttYBRll2TOb4FeMAhU7z"];
    }
    else if (speakerId == 23) {//WhiteCul
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/16ID3H5NhfhV4Yo_9LRaf2aQV7dr8DS68", "https://lh3.googleusercontent.com/d/183q3VSArPBL4REjjyZtagSTltByu6TD0"];
    }
    else if (speakerId == 10) {//雨晴はう
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1AfQNuQHLU9qF4UjSYBCGL2v1aMN6nYbY", "https://lh3.googleusercontent.com/d/1bn9LvyVpMs51gusF7Fs0RUE0jvu6w7Rs"];
    }
    else if (speakerId == 18) {//九州そら
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1HAOuIiyVaqH-SmhVSBX0XpyjZr71r38B", "https://lh3.googleusercontent.com/d/19TOru9JL8LWaEJ9e6XrEUcWQp749NTof"];
    }
    else if (speakerId == 28) {//後鬼(非公式擬人化ver.)
      //open,close     
      eyeUrls = ["https://lh3.googleusercontent.com/d/1D0SrixrMmkqmfxCZjLIlla8gFR4EjuzO", "https://lh3.googleusercontent.com/d/1wpiHmeB4oN1e7XsbUYAJZf3Ji7k-2irc"];
    }
    return eyeUrls ;
  }
</script>
